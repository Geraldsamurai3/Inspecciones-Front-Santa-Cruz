# üéØ Especificaci√≥n del Endpoint /stats/dependencies

## üìã Resumen R√°pido

**Endpoint:** `GET /stats/dependencies`

**Prop√≥sito:** Obtener estad√≠sticas de inspecciones agrupadas por dependencia con filtros de tiempo.

**Autenticaci√≥n:** Bearer Token requerido

---

## üì• Request

### URL
```
GET http://localhost:3000/stats/dependencies
```

### Query Parameters

| Par√°metro | Tipo | Valores Permitidos | Requerido | Descripci√≥n |
|-----------|------|-------------------|-----------|-------------|
| `period` | string | `'7days'` \| `'1week'` \| `'15days'` \| `'1month'` \| `'custom'` | **S√≠** | Per√≠odo de tiempo para el an√°lisis |
| `startDate` | string | `'YYYY-MM-DD'` | Solo si `period='custom'` | Fecha de inicio del per√≠odo |
| `endDate` | string | `'YYYY-MM-DD'` | Solo si `period='custom'` | Fecha final del per√≠odo |

### Headers
```http
Authorization: Bearer <token>
Content-Type: application/json
```

### Ejemplos de Request

**1. √öltimos 7 d√≠as:**
```http
GET /stats/dependencies?period=7days
```

**2. √öltima semana:**
```http
GET /stats/dependencies?period=1week
```

**3. √öltimo mes:**
```http
GET /stats/dependencies?period=1month
```

**4. Per√≠odo personalizado:**
```http
GET /stats/dependencies?period=custom&startDate=2025-09-01&endDate=2025-09-30
```

---

## üì§ Response

### ‚úÖ Success (200 OK)

```json
{
  "period": "√öltimos 7 d√≠as",
  "startDate": "2025-09-23",
  "endDate": "2025-09-30",
  "total": 145,
  "byDependency": [
    {
      "dependency": "Alcald√≠a",
      "total": 45,
      "byStatus": {
        "nuevo": 10,
        "enProceso": 15,
        "revisado": 15,
        "archivado": 5
      },
      "percentage": 31.03
    },
    {
      "dependency": "Construcciones",
      "total": 32,
      "byStatus": {
        "nuevo": 8,
        "enProceso": 12,
        "revisado": 10,
        "archivado": 2
      },
      "percentage": 22.07
    },
    {
      "dependency": "Bienes Inmuebles",
      "total": 28,
      "byStatus": {
        "nuevo": 5,
        "enProceso": 10,
        "revisado": 10,
        "archivado": 3
      },
      "percentage": 19.31
    },
    {
      "dependency": "Cobros",
      "total": 20,
      "byStatus": {
        "nuevo": 4,
        "enProceso": 8,
        "revisado": 6,
        "archivado": 2
      },
      "percentage": 13.79
    },
    {
      "dependency": "Rentas y Patentes",
      "total": 12,
      "byStatus": {
        "nuevo": 2,
        "enProceso": 5,
        "revisado": 4,
        "archivado": 1
      },
      "percentage": 8.28
    },
    {
      "dependency": "Plataformas de servicios",
      "total": 5,
      "byStatus": {
        "nuevo": 1,
        "enProceso": 2,
        "revisado": 2,
        "archivado": 0
      },
      "percentage": 3.45
    },
    {
      "dependency": "ZMT",
      "total": 3,
      "byStatus": {
        "nuevo": 1,
        "enProceso": 1,
        "revisado": 1,
        "archivado": 0
      },
      "percentage": 2.07
    }
  ]
}
```

### Schema

```typescript
interface DependenciesResponse {
  period: string;           // Descripci√≥n del per√≠odo ("√öltimos 7 d√≠as", etc.)
  startDate: string;        // Formato: YYYY-MM-DD
  endDate: string;          // Formato: YYYY-MM-DD
  total: number;            // Total de inspecciones en el per√≠odo
  byDependency: Dependency[];
}

interface Dependency {
  dependency: string;       // Nombre de la dependencia
  total: number;            // Total de inspecciones en esta dependencia
  byStatus: StatusCounts;
  percentage: number;       // Porcentaje del total (ej: 31.03)
}

interface StatusCounts {
  nuevo: number;            // ‚ö†Ô∏è IMPORTANTE: min√∫scula, camelCase
  enProceso: number;        // ‚ö†Ô∏è IMPORTANTE: camelCase
  revisado: number;         // ‚ö†Ô∏è IMPORTANTE: min√∫scula
  archivado: number;        // ‚ö†Ô∏è IMPORTANTE: min√∫scula
}
```

---

## ‚ùå Error Responses

### 400 Bad Request - Per√≠odo inv√°lido

```json
{
  "error": "Invalid period parameter",
  "message": "Period must be one of: 7days, 1week, 15days, 1month, custom"
}
```

**Cu√°ndo ocurre:** Cuando `period` no es uno de los valores permitidos.

---

### 400 Bad Request - Fechas faltantes

```json
{
  "error": "Missing date parameters",
  "message": "startDate and endDate are required when period is 'custom'"
}
```

**Cu√°ndo ocurre:** Cuando `period='custom'` pero falta `startDate` o `endDate`.

---

### 400 Bad Request - Rango de fechas inv√°lido

```json
{
  "error": "Invalid date range",
  "message": "startDate must be before or equal to endDate"
}
```

**Cu√°ndo ocurre:** Cuando `startDate > endDate`.

---

### 401 Unauthorized

```json
{
  "error": "Unauthorized",
  "message": "Authentication token is required"
}
```

**Cu√°ndo ocurre:** Cuando no se proporciona el token de autenticaci√≥n.

---

### 500 Internal Server Error

```json
{
  "error": "Internal server error",
  "message": "Error calculating dependencies statistics"
}
```

**Cu√°ndo ocurre:** Error en el servidor al procesar la solicitud.

---

## üîß Implementaci√≥n Backend (Ejemplo en Node.js/Express)

### Controlador

```javascript
// controllers/statsController.js
const getDependencies = async (req, res) => {
  try {
    const { period = '7days', startDate, endDate } = req.query;

    // Validar per√≠odo
    const validPeriods = ['7days', '1week', '15days', '1month', 'custom'];
    if (!validPeriods.includes(period)) {
      return res.status(400).json({
        error: 'Invalid period parameter',
        message: 'Period must be one of: 7days, 1week, 15days, 1month, custom'
      });
    }

    // Validar fechas para per√≠odo custom
    if (period === 'custom') {
      if (!startDate || !endDate) {
        return res.status(400).json({
          error: 'Missing date parameters',
          message: 'startDate and endDate are required when period is custom'
        });
      }

      if (new Date(startDate) > new Date(endDate)) {
        return res.status(400).json({
          error: 'Invalid date range',
          message: 'startDate must be before or equal to endDate'
        });
      }
    }

    // Calcular fechas seg√∫n el per√≠odo
    let calculatedStartDate, calculatedEndDate;
    const now = new Date();

    switch (period) {
      case '7days':
        calculatedEndDate = now;
        calculatedStartDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
        break;
      case '1week':
        calculatedEndDate = now;
        calculatedStartDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
        break;
      case '15days':
        calculatedEndDate = now;
        calculatedStartDate = new Date(now.getTime() - 15 * 24 * 60 * 60 * 1000);
        break;
      case '1month':
        calculatedEndDate = now;
        calculatedStartDate = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
        break;
      case 'custom':
        calculatedStartDate = new Date(startDate);
        calculatedEndDate = new Date(endDate);
        break;
    }

    // Formatear fechas a YYYY-MM-DD
    const formatDate = (date) => date.toISOString().split('T')[0];
    const formattedStartDate = formatDate(calculatedStartDate);
    const formattedEndDate = formatDate(calculatedEndDate);

    // Obtener datos de la base de datos
    const inspections = await Inspection.find({
      createdAt: {
        $gte: calculatedStartDate,
        $lte: calculatedEndDate
      }
    });

    // Agrupar por dependencia
    const dependenciesMap = {};
    let totalInspections = 0;

    inspections.forEach(inspection => {
      const dep = inspection.dependencia || 'Sin Dependencia';
      
      if (!dependenciesMap[dep]) {
        dependenciesMap[dep] = {
          dependency: dep,
          total: 0,
          byStatus: {
            nuevo: 0,
            enProceso: 0,
            revisado: 0,
            archivado: 0
          }
        };
      }

      dependenciesMap[dep].total++;
      totalInspections++;

      // Contar por estado (asegurar min√∫sculas y camelCase)
      const status = inspection.estado.toLowerCase();
      switch (status) {
        case 'nuevo':
          dependenciesMap[dep].byStatus.nuevo++;
          break;
        case 'en proceso':
        case 'enproceso':
          dependenciesMap[dep].byStatus.enProceso++;
          break;
        case 'revisado':
          dependenciesMap[dep].byStatus.revisado++;
          break;
        case 'archivado':
          dependenciesMap[dep].byStatus.archivado++;
          break;
      }
    });

    // Convertir a array y calcular porcentajes
    const byDependency = Object.values(dependenciesMap)
      .map(dep => ({
        ...dep,
        percentage: totalInspections > 0 
          ? parseFloat(((dep.total / totalInspections) * 100).toFixed(2))
          : 0
      }))
      .sort((a, b) => b.total - a.total); // Ordenar por total descendente

    // Mapear label del per√≠odo
    const periodLabels = {
      '7days': '√öltimos 7 d√≠as',
      '1week': '√öltima semana',
      '15days': '√öltimos 15 d√≠as',
      '1month': '√öltimo mes',
      'custom': 'Per√≠odo personalizado'
    };

    // Respuesta
    res.json({
      period: periodLabels[period],
      startDate: formattedStartDate,
      endDate: formattedEndDate,
      total: totalInspections,
      byDependency
    });

  } catch (error) {
    console.error('Error in getDependencies:', error);
    res.status(500).json({
      error: 'Internal server error',
      message: 'Error calculating dependencies statistics'
    });
  }
};

module.exports = { getDependencies };
```

### Ruta

```javascript
// routes/statsRoutes.js
const express = require('express');
const router = express.Router();
const { getDependencies } = require('../controllers/statsController');
const { authenticateToken } = require('../middleware/auth');

router.get('/dependencies', authenticateToken, getDependencies);

module.exports = router;
```

---

## üß™ Testing con cURL

### Test 1: √öltimos 7 d√≠as

```bash
curl -X GET "http://localhost:3000/stats/dependencies?period=7days" \
  -H "Authorization: Bearer YOUR_TOKEN_HERE"
```

### Test 2: Per√≠odo personalizado

```bash
curl -X GET "http://localhost:3000/stats/dependencies?period=custom&startDate=2025-09-01&endDate=2025-09-30" \
  -H "Authorization: Bearer YOUR_TOKEN_HERE"
```

### Test 3: Error - Per√≠odo inv√°lido

```bash
curl -X GET "http://localhost:3000/stats/dependencies?period=invalid" \
  -H "Authorization: Bearer YOUR_TOKEN_HERE"
```

### Test 4: Error - Sin fechas en custom

```bash
curl -X GET "http://localhost:3000/stats/dependencies?period=custom" \
  -H "Authorization: Bearer YOUR_TOKEN_HERE"
```

---

## üìä SQL Query (para bases de datos relacionales)

```sql
-- PostgreSQL / MySQL
SELECT 
  i.dependencia AS dependency,
  COUNT(*) AS total,
  SUM(CASE WHEN i.estado = 'nuevo' THEN 1 ELSE 0 END) AS nuevo,
  SUM(CASE WHEN i.estado = 'enProceso' OR i.estado = 'en proceso' THEN 1 ELSE 0 END) AS enProceso,
  SUM(CASE WHEN i.estado = 'revisado' THEN 1 ELSE 0 END) AS revisado,
  SUM(CASE WHEN i.estado = 'archivado' THEN 1 ELSE 0 END) AS archivado,
  ROUND(
    (COUNT(*) * 100.0 / (
      SELECT COUNT(*) 
      FROM inspecciones 
      WHERE fecha BETWEEN ? AND ?
    )), 
    2
  ) AS percentage
FROM inspecciones i
WHERE i.fecha BETWEEN ? AND ?
GROUP BY i.dependencia
ORDER BY total DESC;
```

---

## üîç MongoDB Query (para bases de datos NoSQL)

```javascript
db.inspecciones.aggregate([
  {
    $match: {
      createdAt: {
        $gte: new Date("2025-09-23"),
        $lte: new Date("2025-09-30")
      }
    }
  },
  {
    $group: {
      _id: "$dependencia",
      total: { $sum: 1 },
      nuevo: {
        $sum: { $cond: [{ $eq: ["$estado", "nuevo"] }, 1, 0] }
      },
      enProceso: {
        $sum: { 
          $cond: [
            { $or: [
              { $eq: ["$estado", "enProceso"] },
              { $eq: ["$estado", "en proceso"] }
            ]}, 
            1, 
            0
          ] 
        }
      },
      revisado: {
        $sum: { $cond: [{ $eq: ["$estado", "revisado"] }, 1, 0] }
      },
      archivado: {
        $sum: { $cond: [{ $eq: ["$estado", "archivado"] }, 1, 0] }
      }
    }
  },
  {
    $sort: { total: -1 }
  }
]);
```

---

## ‚úÖ Checklist de Implementaci√≥n

### Backend
- [ ] Crear ruta `/stats/dependencies`
- [ ] Implementar validaci√≥n de par√°metros
- [ ] Implementar c√°lculo de fechas seg√∫n per√≠odo
- [ ] Consultar base de datos con filtro de fechas
- [ ] Agrupar inspecciones por dependencia
- [ ] Contar por estado (nuevo, enProceso, revisado, archivado)
- [ ] Calcular porcentajes
- [ ] Ordenar por total descendente
- [ ] Formatear respuesta seg√∫n schema
- [ ] Implementar manejo de errores
- [ ] Agregar autenticaci√≥n con Bearer token
- [ ] Probar con diferentes per√≠odos
- [ ] Probar casos de error

### Testing
- [ ] Test con per√≠odo '7days'
- [ ] Test con per√≠odo '1week'
- [ ] Test con per√≠odo '15days'
- [ ] Test con per√≠odo '1month'
- [ ] Test con per√≠odo 'custom' y fechas v√°lidas
- [ ] Test error: per√≠odo inv√°lido
- [ ] Test error: custom sin fechas
- [ ] Test error: startDate > endDate
- [ ] Test error: sin token de autenticaci√≥n
- [ ] Test con dependencias vac√≠as
- [ ] Test con muchas dependencias
- [ ] Verificar suma de totales
- [ ] Verificar porcentajes suman ~100%

---

## üìù Notas Importantes

### ‚ö†Ô∏è Convenciones de Nombres

**Estados en la respuesta (byStatus):**
- ‚úÖ `nuevo` - Correcto (min√∫scula, camelCase)
- ‚úÖ `enProceso` - Correcto (camelCase)
- ‚úÖ `revisado` - Correcto (min√∫scula)
- ‚úÖ `archivado` - Correcto (min√∫scula)

**NO usar:**
- ‚ùå `Nuevo` (may√∫scula inicial)
- ‚ùå `En proceso` (espacios)
- ‚ùå `en_proceso` (snake_case)
- ‚ùå `NUEVO` (may√∫sculas)

### üìê C√°lculos

**Total por dependencia:**
```
total = nuevo + enProceso + revisado + archivado
```

**Porcentaje:**
```
percentage = (dependency.total / totalGeneral) * 100
```

**Redondeo:**
```
percentage = Math.round(percentage * 100) / 100  // 2 decimales
```

### üé® Ordenamiento

Las dependencias deben estar ordenadas por `total` en orden **descendente** (mayor a menor).

### üìÖ Formato de Fechas

Todas las fechas en formato **ISO 8601**: `YYYY-MM-DD`

Ejemplo: `"2025-09-30"`

---

**√öltima actualizaci√≥n:** 30 de Septiembre, 2025  
**Versi√≥n:** 1.0.0
